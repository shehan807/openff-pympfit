memory {{ memory }}

molecule mol {
  noreorient
  nocom
  {{ charge }} {{ spin }}
  {% for atom in atoms -%}
  {{ atom.element }} {{ '% 0.9f' | format(atom.x|float) }} {{ '% 0.9f' | format(atom.y|float) }} {{ '% 0.9f' | format(atom.z|float) }}
  {% endfor %}
}

set {
  basis {{ basis }}
{%- if compute_mp %}
  # GDMA options
  gdma_limit    {{ limit }}
  gdma_multipole_units {{ multipole_units }}
  gdma_radius   {{ radius }}
  gdma_switch   {{ switch }}
  
  {% if gdma_origin -%}
  gdma_origin   {{ gdma_origin }}
  {% endif -%}
{%- endif %}
}

{%- if minimize %}
optimize('{{ method }}')
{%- endif %}

# Calculate the wavefunction
energy, wfn = energy('{{ method }}', return_wfn=True)

{%- if compute_mp %}
# Run OEPROP
oeprop(
    wfn,
)
{%- endif %}

# Save final geometry
mol.save_xyz_file('final-geometry.xyz', 1)

{%- if compute_mp %}
# Get GDMA results
dma_distributed = variable("DMA DISTRIBUTED MULTIPOLES")
dma_total = variable("DMA TOTAL MULTIPOLES")

import numpy as np

# Convert Matrix objects to NumPy arrays
dma_distributed_array = dma_distributed.to_array()
dma_total_array = dma_total.to_array()

# Save arrays to disk
np.save('dma_distributed.npy', dma_distributed_array)
np.save('dma_total.npy', dma_total_array)
{%- endif %}
